# Prometheus and PagerDuty Integration

Connecting PagerDuty to Prometheus to:

* Notify on-call responders based on alerts triggered from Prometheus.

* See incidents and escalations.

* Get daily reminders as to who is on-call.

What youâ€™ll need:

* Admin or Standard role permissions for your Prometheus account (unless your organization has created a custom role).

* Permission to create a new service in PagerDuty.

## Integration

### Prerequisites

The following steps guide preparing the PagerDuty receiver for the Alertmanager to send alerts.

1. Refer to the [configuration guide](https://grafana.com/blog/2020/02/25/step-by-step-guide-to-setting-up-prometheus-alertmanager-with-slack-pagerduty-and-gmail/) for step-by-step guidance on configuring the PagerDuty service to receive notifications from the Prometheus Alertmanager.

1. PagerDuty Configuration:

    * Access your PagerDuty portal with permission to create a new service.

    * Create a new Configuration Services. The following screenshots will guide you in creating a PagerDuty service.

        * Select New Service.

        * Specify the Service Name.

            ![New Service](./images/PD-1.png)

        * Assign Escalation Policy. Select Next.

            ![Escalation Policy](./images/PD-2.png)

        * Reduce Noise. Select Next.

            ![Reduce Noise](./images/PD-3.png)

        * Select Integration Service as Prometheus and select Create Service.

            ![Integration](./images/PD-4.png)

    * After creating the service, copy the service key. e.g. `98c3d3add5xe4f_TAMPERED_fdc62`. This service key will be used in the Alertmanager configuration.

### Configure Alertmanager for PagerDuty

Before performing the following steps, ensure that the Alertmanager is installed and configured to run as a service. Refer to the [Alertmanager installation guide](./Prometheus_Monitor_configuration_and_alerting.md).

The following configuration is designed to receive alerts with severity level `L1`. By default, all alerts will go to Slack. However, the alerts with severity level `L1` will be sent to PagerDuty.

* Perform the following steps to configure the Alertmanager to integrate with PagerDuty.

* Update the service key generated by pagerDuty in the previous step.

**Note:** The keys and webhooks provided in the following configuration are tampered with. The keys and webhooks must be updated as per the environment. Add the following configurations to the alertmanager.yml file. Refer to the final [Alertmanager configuration](.configs/alertmanager.yml) file.

```sh
vi /etc/alertmanager/alertmanager.yml
```

```sh
routes:
    - match:
        severity: L1
      receiver: pagerduty
      group_by: ['...']
receivers:
  - name: pagerduty
    pagerduty_configs:
    - service_key: 98c3d3add5de4f0dc0726243ee3fdc62
      send_resolved: true
```

Run the following command to restart the Alertmanager service:

```sh
systemctl daemon-reload
systemctl start alertmanager
systemctl status alertmanager
```

## PagerDuty Alerts

The following screenshots will show the PagerDuty Console and Alert as examples.

![PagerDuty Console](./images/PD-5.png)

![PagerDuty Alert](./images/PD-6.png)
