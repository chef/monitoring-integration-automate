# MS Teams Integration and Notification
Connect MS Teams to Prometheus to:

* Notify on-call responders based on alerts triggered from prometheus.
* See incidents and escalations.
* Get daily reminders as to who is on-call.

What you’ll need:

 * Admin or Standard role permissions for your prometheus account (unless your organization has created custom role)
 * Permissions to create new service in MS Teams 

## prometheus and MS Teams Integration
### Prerequisites
The following steps provides the guidance to prepare MS Teams receiver for the alert manager to send alerts. 

* MS Teams Notification  
   
   https://github.com/prometheus-msteams/prometheus-msteams/releases
   

* After creating the service, copy the service key. e.g. `98c3d3add5xe4f0xc3726243ee3fdc62` . This service key will be used in alertmanager configuration.

### Configure AlertManager for MS Teams

Before perforoming the following steps, please ensure alertmanger is installed and configured to run as a service. Refer to the ![alertmanger installation guide](./Prometheus_Monitor_configuration_and_alerting.md)

The following configuration is designed to receive alerts with severity level `page`. By default, all alerts will go to Slack, however, the alerts with severity level `page` will be sent to Padgerduty.

* Perform the following steps to configure alert manager to integration with MS Teams. 

* Update the service key generated by MS Teams.

Please note: The keys and webhooks provided in the following configuration are tampered. The keys and webhooks must be updated as per the environment.

```
vi /etc/alertmanager/alertmanager.yml
```

```
route:
  # A default receiver
  receiver: slack

  routes:
    - match:
        severity: page
      continue: true
      receiver: slack
    - match:
        severity: page
      receiver: pagerduty

receivers:
  - name: pagerduty
    pagerduty_configs:
    - service_key: 98c3d3add5de4f0dc0726243ee3fdc62
      send_resolved: true
  - name: slack
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/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'
        send_resolved: true
        channel: '#prometheus-monitoring'
        title: |-
          [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }} for {{ .CommonLabels.job }}
          {{- if gt (len .CommonLabels) (len .GroupLabels) -}}
            {{" "}}(
            {{- with .CommonLabels.Remove .GroupLabels.Names }}
              {{- range $index, $label := .SortedPairs -}}
                {{ if $index }}, {{ end }}
                {{- $label.Name }}="{{ $label.Value -}}"
              {{- end }}
            {{- end -}}
            )
          {{- end }}
        text: >-
          {{ range .Alerts -}}
          *Alert:* {{ .Annotations.title }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}

          *Description:* {{ .Annotations.description }}

          *Details:*
             {{ range .Labels.SortedPairs }} • *{{ .Name }}:* `{{ .Value }}`
             {{ end }}
          {{ end }}
```

Run the following command to restart alert manager service

```
systemctl daemon-reload
systemctl start alertmanager
systemctl status alertmanager
```
