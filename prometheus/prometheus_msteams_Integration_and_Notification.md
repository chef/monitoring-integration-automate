# MS Teams Integration and Notification
Connect MS Teams to Prometheus to:

* Notify on-call responders based on alerts triggered from prometheus.
* See incidents and escalations.
* Get daily reminders as to who is on-call.
   
## Configure AlertManager for MS Teams
Before performing the following steps, please ensure alertmanager is installed and configured to run as a service. Refer to the ![alertmanager installation guide](./Prometheus_Monitor_configuration_and_alerting.md)

## prometheus and MS Teams Integration

The following steps provides the guidance to prepare MS Teams receiver for the alert manager to send alerts. Refer to [prometheus-msteams documentation](https://github.com/prometheus-msteams/prometheus-msteams/releases) for more details.

### Configure MS Teams
* Create Team

* Create Team Channel
  
  Create a channel in Ms-teams where you want to send alerts. 

* Create Incoming Webhook

  - Click on connectors(found connectors in options of the channel), and then search for ‘incoming webhook’ connector.
  ![Incoming Webhook Connector](./images/msteam-1.png)

  - Create a webhook of this channel. Incoming webhook is used to send notification from external services to track the activities.
  ![Select Channel](./images/msteam-2.png)
  ![Assign Incoming Webhook Name](./images/msteam-3.png)
  - Click Create
  - Copy the Webhook url and click done.
    This webhook url will be used in the next step.

#### Install and Configure Docker image
```
apt install docker.io
```

* The prometheus-msteams proxy container is configured on prometheus server with port number 2000. Please ensure firewall is opened for this port.

* Updated TEAMS_INCOMING_WEBHOOK_URL with the url link generated above.

```
docker run -d -p 2000:2000 \
    --name="promteams" \
    -e TEAMS_INCOMING_WEBHOOK_URL="https://progresssoftware.webhook.office.com/webhookb2/19e1c444-fa6a-4d9a-b339-c527940dbaac@db266a67-cbe0-4d26-ae1a-d0581fe03535/IncomingWebhook/43f87f7d1724404394e28b24c50deb51/890e3fec-12ba-4296-8e94-6018f6821896" \
    -e TEAMS_REQUEST_URI=alertmanager \
    quay.io/prometheusmsteams/prometheus-msteams
```

## Configure Alertmanager

* Add the following configuration in alartmanager.yml file
```
vi /etc/alertmanager/alertmanager.yml
```

```
route:
  routes:
    - match:
        severity: L2
      receiver: prometheus-msteams
      group_by: ['...']

receivers:
  - name: 'prometheus-msteams'
    webhook_configs: # https://prometheus.io/docs/alerting/configuration/#webhook_config
    - send_resolved: true
      url: 'http://localhost:2000/alertmanager'
```

Restart Alertmanager and prometheus server

```
systemctl restart alertmanager.service
systemctl restart prometheus.service
```



The following configuration is designed to receive alerts with severity level `page`. By default, all alerts will go to Slack, however, the alerts with severity level `page` will be sent to Padgerduty.

* Perform the following steps to configure alert manager to integration with MS Teams. 

* Update the service key generated by MS Teams.

Please note: The keys and webhooks provided in the following configuration are tampered. The keys and webhooks must be updated as per the environment.

```
vi /etc/alertmanager/alertmanager.yml
```

```
route:
  # A default receiver
  receiver: slack

  routes:
    - match:
        severity: page
      continue: true
      receiver: slack
    - match:
        severity: page
      receiver: pagerduty

receivers:
  - name: pagerduty
    pagerduty_configs:
    - service_key: 98c3d3add5de4f0dc0726243ee3fdc62
      send_resolved: true
  - name: slack
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/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'
        send_resolved: true
        channel: '#prometheus-monitoring'
        title: |-
          [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }} for {{ .CommonLabels.job }}
          {{- if gt (len .CommonLabels) (len .GroupLabels) -}}
            {{" "}}(
            {{- with .CommonLabels.Remove .GroupLabels.Names }}
              {{- range $index, $label := .SortedPairs -}}
                {{ if $index }}, {{ end }}
                {{- $label.Name }}="{{ $label.Value -}}"
              {{- end }}
            {{- end -}}
            )
          {{- end }}
        text: >-
          {{ range .Alerts -}}
          *Alert:* {{ .Annotations.title }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}

          *Description:* {{ .Annotations.description }}

          *Details:*
             {{ range .Labels.SortedPairs }} • *{{ .Name }}:* `{{ .Value }}`
             {{ end }}
          {{ end }}
```

Run the following command to restart alert manager service

```
systemctl daemon-reload
systemctl start alertmanager
systemctl status alertmanager
```
